<html>
<head>
    <script src="chroma.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/flot/0.8.2/jquery.flot.min.js"></script>
</style>
</head>
<body>
    <script>
    var plot, cf, span, resBw, vidBw, refLvl, scale, delay;
    var socket = io.connect();
    var started = false;
    var tempCanvas = document.createElement("canvas");
    var tempCtx = tempCanvas.getContext("2d");
    tempCanvas.width=500;
    tempCanvas.height=300;

    socket.on('connected', onConnected);
    socket.on('psd', onPsd);
    
    $(document).ready(function () {
        var options = {
            series:  {shadowSize: 0},
            colors: ['green']
        };

        plot = $.plot($("#placeholder"), [], options);

        // Set initial values
        applyValues();

        $("#apply").click(applyValues);
        $("#stopStart").click(onStopStartClick);
    });

    function onStopStartClick() {
        started = !started;

        if(started)
        {
            $("#stopStart").text('Stop');
            requestPsd();
        }
        else
        {
            $("#stopStart").text('Start');
        }
    }

    function applyValues() {
        cf = $("#cfTxt").val();
        span = $("#spanTxt").val();
        resBw = $("#resBwTxt").val();
        vidBw = $("#vidBwTxt").val();
        refLvl = $("#refLvlTxt").val();
        scale = $("#scaleTxt").val();
        delay = $("#delayTxt").val();
    }

    function requestPsd() {
        console.log("Requesting new psd...");
        socket.emit(
            'getPsd',
            {
                cf: cf, 
                span: span, 
                resBw: resBw, 
                vidBw: vidBw,
                refLvl: refLvl,
                scale: scale
            }
        );
    }

    function onConnected(data) {
        console.log("Connected successfully");
        requestPsd();
        started = true;
    }

    function onPsd(data) {
        console.log("Recieved psd: ")
        console.log(data);

        // Get plottable data
        var series = []
        for (var i = 0; i < data.freq.length; i++) {
            series.push([data.freq[i], data.psd[i]]);
        };

        // Plot data
        var options = plot.getOptions();
        options.yaxes[0].max = refLvl;
        options.yaxes[0].min = refLvl - 10 * scale;

        plot.setData([series]);
        plot.setupGrid();
        plot.draw();

        drawWaterfall(data.psd);

        if (!started)
            return;

        setTimeout(requestPsd, delay);
    }

    // TODO: push this to bg thread?
    function scaleDown(y, newLength) {
        var newY = [];
        var dx = y.length / newLength;
        for(var i = 0; i < newLength; i++) {
            var x = i*dx;

            var x1 = Math.ceil(x);
            if(x1 == y.length)
                x1 = Math.floor(x);
            var x0 = x1 - 1;

            var y0 = y[x0];
            var y1 = y[x1];
            var yi = y0 + (y1 - y0)*(x -x0);
            newY.push(yi);

            if(i == newLength - 1) {
                console.log(yi);
                console.log(x);
                console.log(x0);
                console.log(x1);
                console.log(y0);
                console.log(y1);
            }
        }
        return newY;
    }
 
        /*
        for(var i = 0; i < newLength; i++) {
            var sum = 0;
            var nPts = 0;
            for(var j = 0; j < binSize; j++) {
                if((i * binSize) + j < data.length) {
                    var val = y[(i * binSize) + j];
                    sum += val;
                    nPts++;
                }
            }

            newY.push(sum/nPts);
        }*/

    /*
    function scaleUp(x, y, newLength) {
        var newY = [];
        var newX = [];

        var step = (x[x.length - 1] - x[0]) / newLength;

        newX.push(x[0]);

        for(var i = 1; i < x.length; i++)
        {
            var x0 = x[i - 1];
            var x1 = x[i];
            var y0 = y[i - 1];
            var y1 = y[i];
            for(var j = 0; j < newLength; j++) {

            }
        }

        for(var i = 1; i < data.newLength; i++) {
            newX.push(newX[i - 1] + step);
        }
    }*/

    function drawWaterfall(data) {
        var canvas = document.getElementById("waterfall");
        var ctx = $("#waterfall").get()[0].getContext("2d");
        tempCtx.drawImage(canvas, 0, 0, 500, 300);

        var scale = chroma.scale(['#000000','#0B16B5','#FFF782','#EB1250'])
                          .domain([-1,1]);

        // Bin down the data to fit on the plot
        // TODO: handle scaling up
        var pixelValues = scaleDown(data, 500);

        for (var i = 0; i < 500; i++) {
            var val = pixelValues[i];
            ctx.fillStyle = scale(val).hex();
            ctx.fillRect(i, 299, 1, 1);
        }
        ctx.drawImage(tempCanvas, 0, 0, 500, 300, 0, -1, 500, 300);
    }
    </script>
    <canvas id="waterfall" width="500" height="300" style="display: block; background-color: black; z-index: -1;"></canvas>
    <div id="placeholder" style="width:500px;height:300px"></div>
    <ul>
        <li>Center Frequency (MHz): <input type="textbox" value=20 id="cfTxt"> 
        <li>Span (MHz): <input type="textbox" value=10 id="spanTxt"> 
        <li>Res. BW (kHz): <input type="textbox" value=0.01 id="resBwTxt"> 
        <li>Vid. BW (kHz): <input type="textbox" value=0.01 id="vidBwTxt"> 
        <li>Ref. Level (dBm/Hz): <input type="textbox" value=2.0 id="refLvlTxt"> 
        <li>Scale (dB/div): <input type="textbox" value=0.4 id="scaleTxt">
        <li>Delay (ms): <input type="textbox" value=200 id="delayTxt">
    </ul>
    <button id="apply">Apply</button>
    <button id="stopStart">Stop</button>
</body>
</html>
        }